# Dockerfile.ubuntu â€” E2E test image for gentleman-ai on Ubuntu 22.04
# Builds the binary from source and runs the E2E test suite as a non-root user.
FROM ubuntu:22.04

ARG DEBIAN_FRONTEND=noninteractive

# ---------------------------------------------------------------------------
# System dependencies
# ---------------------------------------------------------------------------
RUN apt-get update && apt-get install -y --no-install-recommends \
        git \
        curl \
        sudo \
        ca-certificates \
        build-essential \
    && rm -rf /var/lib/apt/lists/*

# ---------------------------------------------------------------------------
# Install Go (match go.mod version)
# ---------------------------------------------------------------------------
ARG GO_VERSION=1.22.5
RUN curl -fsSL "https://go.dev/dl/go${GO_VERSION}.linux-amd64.tar.gz" \
    | tar -C /usr/local -xz
ENV PATH="/usr/local/go/bin:${PATH}"

# ---------------------------------------------------------------------------
# Create non-root test user with passwordless sudo
# ---------------------------------------------------------------------------
RUN useradd -m -s /bin/bash testuser && \
    echo "testuser ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# ---------------------------------------------------------------------------
# Copy project source and build
# ---------------------------------------------------------------------------
WORKDIR /build
COPY go.mod go.sum ./
RUN go mod download
COPY . .
RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 \
    go build -o /usr/local/bin/gentleman-ai ./cmd/gentleman-ai

# ---------------------------------------------------------------------------
# Prepare test environment
# ---------------------------------------------------------------------------
COPY e2e/lib.sh     /home/testuser/e2e/lib.sh
COPY e2e/e2e_test.sh /home/testuser/e2e/e2e_test.sh
RUN chmod +x /home/testuser/e2e/e2e_test.sh /home/testuser/e2e/lib.sh && \
    chown -R testuser:testuser /home/testuser

USER testuser
WORKDIR /home/testuser

# ---------------------------------------------------------------------------
# Default: run Tier 1 tests only
# ---------------------------------------------------------------------------
CMD ["./e2e/e2e_test.sh"]
