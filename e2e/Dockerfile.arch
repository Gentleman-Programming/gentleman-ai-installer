# Dockerfile.arch — E2E test image for gentle-ai on Arch Linux
# Builds the binary from source and runs the E2E test suite as a non-root user.
# archlinux:base only provides x86_64 images. Force amd64 platform so Docker
# uses QEMU emulation on ARM hosts (Apple Silicon).
FROM --platform=linux/amd64 archlinux:base

# ---------------------------------------------------------------------------
# System dependencies (includes npm for claude-code tests)
# ---------------------------------------------------------------------------
# Disable pacman's seccomp sandbox — it fails under QEMU emulation on ARM hosts.
# DisableSandbox prevents the ALPM seccomp filter that is incompatible with QEMU user-mode.
RUN echo 'DisableSandbox' >> /etc/pacman.conf && \
    pacman -Syu --noconfirm && \
    pacman -S --noconfirm \
        git \
        curl \
        sudo \
        go \
        npm \
        base-devel \
    && pacman -Scc --noconfirm

# ---------------------------------------------------------------------------
# Create non-root test user with passwordless sudo
# ---------------------------------------------------------------------------
RUN useradd -m -s /bin/bash testuser && \
    echo "testuser ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# ---------------------------------------------------------------------------
# Copy project source and build
# ---------------------------------------------------------------------------
WORKDIR /build
COPY go.mod go.sum ./
RUN go mod download
COPY . .
RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 \
    go build -o /usr/local/bin/gentle-ai ./cmd/gentle-ai

# ---------------------------------------------------------------------------
# Prepare test environment
# ---------------------------------------------------------------------------
COPY e2e/lib.sh     /home/testuser/e2e/lib.sh
COPY e2e/e2e_test.sh /home/testuser/e2e/e2e_test.sh
RUN chmod +x /home/testuser/e2e/e2e_test.sh /home/testuser/e2e/lib.sh && \
    chown -R testuser:testuser /home/testuser

USER testuser

# Ensure go install binaries are on PATH for testuser
ENV GOPATH="/home/testuser/go"
ENV PATH="${GOPATH}/bin:/usr/local/go/bin:${PATH}"

WORKDIR /home/testuser

# ---------------------------------------------------------------------------
# Default: run Tier 1 tests only
# ---------------------------------------------------------------------------
CMD ["./e2e/e2e_test.sh"]
